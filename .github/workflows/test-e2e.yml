name: E2E Tests

on:
  push:
  pull_request:

jobs:
  test-e2e:
    name: Run on Ubuntu with kubevirtci
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils

      - name: Set up kubevirtci
        run: |
          make cluster-up

      - name: Build and deploy webhook
        run: |
          make cluster-sync

      - name: Run e2e tests
        run: |
          make cluster-functest

      - name: Collect logs on failure
        if: failure()
        run: |
          export KUBECONFIG=$(pwd)/_kubevirtci/_ci-configs/k8s-1.30/.kubeconfig
          kubectl get pods -n kubevirt-rbac-webhook-system
          kubectl logs -n kubevirt-rbac-webhook-system -l control-plane=controller-manager --tail=100 || true
          kubectl get events -n kubevirt-rbac-webhook-system --sort-by='.lastTimestamp' || true

      - name: Cleanup
        if: always()
        run: |
          make cluster-down || true
